#!/usr/bin/env bash
# Auto-generated by CMake - DO NOT EDIT MANUALLY
# This script allows building without CMake installed

set -e
cd "$(dirname "$0")/libvscode-diff"

# Detect platform for library extension
if [[ "$OSTYPE" == "darwin"* ]]; then
    PLATFORM="Darwin"
    LIB_EXT="dylib"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    PLATFORM="Linux"
    LIB_EXT="so"
else
    PLATFORM="Unknown"
    LIB_EXT="so"
fi

echo "Building vscode_diff (standalone mode)..."
echo "Compiler: C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Tools/MSVC/14.44.35207/bin/Hostx64/x64/cl.exe"
echo "Platform: $PLATFORM"

# Compiler and flags from CMake configuration
CC="C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Tools/MSVC/14.44.35207/bin/Hostx64/x64/cl.exe"
CFLAGS="/DWIN32 /D_WINDOWS /W3 /O2 /DNDEBUG -Iinclude -Ibuild/include -Ivendor -fPIC"
LDFLAGS="-shared -lm"

# Source files (including bundled utf8proc)
SOURCES="\
default_lines_diff_computer.c \
src/char_level.c \
src/line_level.c \
src/myers.c \
src/optimize.c \
src/sequence.c \
src/range_mapping.c \
src/string_hash_map.c \
src/utils.c \
src/print_utils.c \
src/utf8_utils.c \
vendor/utf8proc.c"

# Build
mkdir -p build
mkdir -p build/include

# Generate version.h
VERSION=$(cat ../VERSION | tr -d '[:space:]')
sed "s/@''PROJECT_VERSION@/$VERSION/g" include/version.h.in > build/include/version.h"

echo "Compiling..."
$CC $CFLAGS $LDFLAGS -o libvscode_diff.$LIB_EXT $SOURCES

echo "Installing to plugin root..."
cp libvscode_diff.$LIB_EXT ../libvscode_diff.$LIB_EXT

echo "âœ“ Build successful: libvscode_diff.$LIB_EXT"
cd ..
